# 🤖 План разработки Telegram бота "Повседневный квест"
## Вариант 3: Быстрое прототипирование перед полным приложением

**Дата:** Октябрь 2025  
**Цель:** Запустить функциональный прототип за 1-2 недели для валидации концепции с реальными пользователями  
**Результат:** Telegram бот с AI-генерацией квестов, системой прогресса и аналитикой  

---

## 📑 Содержание
1. [Архитектура бота](#архитектура-бота)
2. [Функционал MVP](#функционал-mvp)
3. [Технический стек](#технический-стек)
4. [Пошаговый план разработки](#пошаговый-план-разработки)
5. [Интеграция ChatGPT API](#интеграция-chatgpt-api)
6. [Система хранения данных](#система-хранения-данных)
7. [Метрики и аналитика](#метрики-и-аналитика)
8. [От бота к приложению](#от-бота-к-приложению)

---

## 🏗️ Архитектура бота

```
┌─────────────────────────────────────────────────────────┐
│                    TELEGRAM USERS                       │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────────┐
         │      TELEGRAM BOT API (@BotFather)      │
         │        (Webhook или Polling)            │
         └──────────────────────┬──────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
         ┌────────────┐  ┌────────────┐  ┌──────────┐
         │  BOT CORE  │  │CHATGPT API │  │ DATABASE │
         │ (Node.js/  │  │ (Quest     │  │(Firebase/│
         │  Python)   │  │ Generation)│  │ MongoDB) │
         └─────┬──────┘  └────────────┘  └──────────┘
               │
         ┌─────┴─────────────────────────────┐
         │                                   │
         ▼                                   ▼
    ┌─────────────┐              ┌──────────────────┐
    │  MESSAGE    │              │  ASYNC JOBS      │
    │  HANDLERS   │              │  (Reminders,     │
    │ - /start    │              │   Notifications) │
    │ - /addtask  │              └──────────────────┘
    │ - /quests   │
    │ - /done     │
    │ - /profile  │
    └─────────────┘
```

---

## ✨ Функционал MVP

### Фаза 1: Базовый функционал (Неделя 1)

#### 1.1 Команды и взаимодействие

| Команда | Описание | Поведение |
|---------|---------|-----------|
| `/start` | Инициализация | Приветствие, показ меню, создание профиля |
| `/addtask [описание]` | Добавить задачу | Пользователь пишет текст → бот генерирует сюжет через ChatGPT → показывает квест |
| `/quests` | Список текущих квестов | Показать все активные квесты с номерами |
| `/done [номер]` | Отметить квест как выполненный | +XP, проверка уровня, сохранение статистики |
| `/profile` | Профиль пользователя | Уровень, XP, выполненные квесты, бейджи |
| `/stats` | Статистика | Граф прогресса за неделю, топ достижений |
| `/cancel` | Отмена | Выход из текущей операции |

#### 1.2 Пример сценария взаимодействия

```
Пользователь                          Бот
                                      
✍️ /start                    →    "Добро пожаловать в Повседневный квест! 🎮"
                                   [Меню: Добавить задачу | Профиль | Квесты]

✍️ /addtask Сходить в              → "Генерирую твой квест... ⏳"
   магазин                         (вызов ChatGPT)
                                   
                                   → "✅ Квест создан!
                                     📜 Квест #1: Поиск припасов
                                     'Ты — отважный искатель припасов...
                                     Сходи в ближайший магазин и добудь
                                     припасы для выживания!'
                                     +15 XP за выполнение
                                     [Выполнено] [Отмена]"

✍️ [Выполнено]               →    "🎉 Квест выполнен!
                                   +15 XP (всего: 45/300)
                                   Уровень: 1 → скоро повысится!"

✍️ /profile                  →    "👤 Профиль Алекса
                                   📊 Уровень 1 (45/300 XP)
                                   ✅ Квестов выполнено: 1
                                   🏆 Бейджи: Первый шаг"
```

#### 1.3 Система геймификации

```
XP за квесты:
├─ Короткая задача (5-15 мин): 10-15 XP
├─ Средняя задача (15-30 мин): 20-30 XP
├─ Длинная задача (30+ мин): 40-50 XP
└─ Ежедневный бонус (за 3+ квеста/день): +10 XP

Уровни:
├─ Уровень 1: 0-300 XP (Новичок)
├─ Уровень 2: 300-600 XP (Помощник)
├─ Уровень 3: 600-1000 XP (Адепт)
├─ Уровень 4: 1000-1500 XP (Мастер)
└─ Уровень 5+: 1500+ XP (Легенда)

Бейджи:
├─ "Первый шаг" — выполнил 1 квест
├─ "Неутомимый" — 7 дней подряд
├─ "Серийный киллер" — 100 квестов выполнено
├─ "Легенда" — достиг 5-го уровня
└─ "Социальный мотылек" — пригласил 5 друзей
```

#### 1.4 Тематические режимы (начальная версия)

```
По умолчанию: FANTASY (Фэнтези)
├─ Задача: "Сходить в магазин"
│  └─ Сюжет: "Ты искатель припасов в царстве драконов..."
│
├─ Задача: "Помыть посуду"
│  └─ Сюжет: "Дракон оставил гору грязной посуды..."
│
└─ Задача: "Позвонить маме"
   └─ Сюжет: "Королева требует докладов о твоем здоровье..."

Будущие режимы (после MVP):
├─ SCI-FI (Научная фантастика)
├─ CYBERPUNK (Киберпанк)
├─ DETECTIVE (Мистический детектив)
└─ STEAMPUNK (Стимпанк)
```

---

### Фаза 2: Продвинутый функционал (Неделя 2)

#### 2.1 Дополнительные команды

| Команда | Описание |
|---------|---------|
| `/daily` | Ежедневный челлендж — специальный квест за +20 бонус XP |
| `/leaderboard` | Топ 10 игроков по XP (глобальный лидерборд) |
| `/friend_add [user_id]` | Добавить друга и видеть его прогресс |
| `/invite` | Получить реферальную ссылку для приглашения |
| `/settings` | Настройки: время уведомлений, тема, язык |
| `/help` | Справка по командам |

#### 2.2 Напоминания и уведомления

```
Типы уведомлений:
├─ Ежедневное напоминание (настраивается в /settings)
│  └─ "У тебя 3 невыполненных квеста! 📋"
│
├─ Достижение уровня
│  └─ "🎉 Ты достиг уровня 3! Новый статус: Адепт"
│
├─ Достижение бейджа
│  └─ "🏆 Новый бейдж: Неутомимый (7 дней подряд)"
│
└─ Еженедельный отчет (воскресенье 19:00)
   └─ "📊 Твоя неделя: 15 квестов, 250 XP, лучший день: Суббота"
```

#### 2.3 Социальные функции (начальные)

```
Реферальная система:
├─ Пользователь получает ссылку: /invite
├─ Друг переходит и начинает играть
├─ Пригласивший получает: +50 XP + бейдж
├─ Друг получает: +20 XP стартовый бонус

Друзья:
├─ /friend_add [username] → добавить в друзья
├─ /friend_list → список друзей с их уровнями
├─ Видеть статус "онлайн/офлайн"
└─ Возможность посмотреть профиль друга
```

---

## 💻 Технический стек

### Backend

```
Основной язык: Node.js (JavaScript)
  ├─ Фреймворк: Express.js или NestJS (для быстроты возьмем Express)
  ├─ Telegram API: telegraf (популярная библиотека)
  ├─ HTTP клиент: axios (для запросов к ChatGPT)
  └─ Асинхронная очередь: Bull (для напоминаний)

Альтернатива: Python
  ├─ Фреймворк: FastAPI или python-telegram-bot
  ├─ AI библиотека: LangChain (удобнее работать с ChatGPT)
  └─ Асинхронность: asyncio

Рекомендация: Node.js + Express + Telegraf
  ✓ Быстро разворачивается
  ✓ Много примеров и документации
  ✓ Хорошая экосистема пакетов
```

### База данных

```
Вариант 1: Firebase (Рекомендую для MVP)
├─ Firestore для документов (пользователи, квесты, статистика)
├─ Realtime Database для быстрых операций
├─ Authentication встроена
└─ ✓ Бесплатно на старте, просто масштабируется
   ✓ Готовая инфраструктура, не нужно администрировать

Вариант 2: MongoDB + Atlas
├─ Гибкая схема
├─ Хорошие возможности для аналитики
└─ ✓ Бесплатно на старте (512 MB)

Вариант 3: PostgreSQL + Heroku
├─ Надежность, реляционные данные
└─ Больше контроля, но сложнее для MVP

Структура коллекций (для Firebase):
┌─ users/
│  ├─ {userId}/
│  │  ├─ name: "Алекс"
│  │  ├─ level: 3
│  │  ├─ xp: 240
│  │  ├─ totalQuests: 42
│  │  ├─ badges: ["Первый шаг", "Неутомимый"]
│  │  ├─ createdAt: timestamp
│  │  └─ joinedFriends: ["user2", "user5"]
│  └─ ...
│
├─ quests/
│  ├─ {questId}/
│  │  ├─ userId: "user1"
│  │  ├─ title: "Сходить в магазин"
│  │  ├─ story: "Ты — отважный искатель припасов..."
│  │  ├─ completed: false
│  │  ├─ xp: 15
│  │  ├─ createdAt: timestamp
│  │  ├─ completedAt: null
│  │  └─ theme: "fantasy"
│  └─ ...
│
├─ statistics/
│  ├─ {userId}/
│  │  ├─ dailyQuests: {date: count}
│  │  ├─ weeklyXp: number
│  │  ├─ streak: 7
│  │  ├─ longestStreak: 12
│  │  └─ lastActiveAt: timestamp
│  └─ ...
│
└─ analytics/
   ├─ events/
   │  └─ {eventId}/
   │     ├─ userId: "user1"
   │     ├─ event: "quest_completed"
   │     ├─ timestamp: timestamp
   │     └─ metadata: {...}
   └─ ...
```

### API ChatGPT

```
Модель: GPT-3.5-turbo (дешевле, достаточно для текста)
  ├─ Цена: ~$0.0005 за 1K токенов (сравнить с GPT-4)
  └─ Скорость: быстро, обычно <1 сек

Или: GPT-4 (качественнее, дороже)
  ├─ Цена: ~$0.03 за 1K токенов
  └─ Скорость: чуть медленнее

Рекомендация: Начать с GPT-3.5, потом перейти на GPT-4

Примерный расход на 1000 пользователей:
├─ Генерация 3 квестов/день × 1000 = 3000 квестов/день
├─ Примерно 100-150 токенов на квест
├─ 3000 × 150 = 450k токенов/день
├─ 450k × $0.0005 = $225/месяц (GPT-3.5)
└─ Можно оптимизировать кешированием типовых сюжетов

Правильный Prompt для генерации:
┌─────────────────────────────────────────────────────────┐
│ Ты создатель квестов для игры "Повседневный квест".    │
│ Твоя задача превратить обычную бытовую задачу в       │
│ интересный игровой квест с сюжетом.                     │
│                                                         │
│ Правила:                                                │
│ 1. Используй тему: {THEME}                              │
│ 2. Сюжет должен быть 2-3 предложения, не более 150 слов│
│ 3. Он должен быть мотивирующим и забавным              │
│ 4. Не должен содержать оскорбления или токсичность     │
│ 5. Язык: Русский                                         │
│                                                         │
│ Задача: {TASK_DESCRIPTION}                              │
│                                                         │
│ Напиши только текст квеста, без дополнений.             │
└─────────────────────────────────────────────────────────┘
```

---

## 📋 Пошаговый план разработки

### Этап 1: Подготовка (День 1)

#### 1.1 Регистрация и ключи доступа

```
Шаг 1: Создание Telegram бота
├─ Открыть @BotFather в Telegram
├─ Команда: /newbot
├─ Следовать инструкциям
├─ Получить: BOT_TOKEN (токен доступа)
└─ Скопировать и сохранить в переменные окружения

Шаг 2: Получить API ключ OpenAI
├─ Перейти на https://platform.openai.com/api/keys
├─ Создать новый ключ
├─ Получить: OPENAI_API_KEY
└─ Скопировать и сохранить (только один раз видится!)

Шаг 3: Настроить Firebase проект
├─ Перейти на https://firebase.google.com
├─ Создать новый проект: "everyday-quest"
├─ Включить: Firestore + Authentication
├─ Скачать Firebase config JSON
└─ Получить: Firebase credentials
```

#### 1.2 Подготовка окружения

```
Создать структуру проекта:
telegram-bot-quest/
├── src/
│   ├── bot.js              # Главный файл бота
│   ├── handlers/           # Обработчики команд
│   │   ├── startHandler.js
│   │   ├── taskHandler.js
│   │   ├── questHandler.js
│   │   └── profileHandler.js
│   ├── services/           # Бизнес-логика
│   │   ├── questService.js # Генерация сюжетов
│   │   ├── userService.js  # Управление пользователями
│   │   ├── xpService.js    # Система XP/уровней
│   │   └── analyticsService.js
│   ├── integrations/       # Внешние сервисы
│   │   ├── chatgpt.js      # ChatGPT API
│   │   ├── firebase.js     # Firebase подключение
│   │   └── telegram.js     # Telegram API
│   └── utils/              # Утилиты
│       ├── prompts.js      # Шаблоны промптов
│       ├── constants.js    # Константы
│       └── logger.js       # Логирование
├── .env                     # Переменные окружения
├── .env.example             # Пример конфига
├── package.json
├── README.md
└── docker-compose.yml       # Для локального запуска

Переменные окружения (.env):
├─ BOT_TOKEN=123456:ABC... (от @BotFather)
├─ OPENAI_API_KEY=sk-... (от OpenAI)
├─ FIREBASE_PROJECT_ID=everyday-quest
├─ FIREBASE_PRIVATE_KEY=... (из JSON)
├─ FIREBASE_CLIENT_EMAIL=... (из JSON)
├─ NODE_ENV=development
└─ LOG_LEVEL=debug
```

---

### Этап 2: Основной функционал (Дни 2-5)

#### 2.1 День 2: Базовая структура бота

```
Что реализовать:
├─ Инициализация Telegraf бота
├─ Подключение к Firebase
├─ Команда /start с меню
├─ Обработка ошибок
└─ Логирование событий

Результат:
└─ Бот отвечает на /start, показывает меню, готов к командам
```

#### 2.2 День 3: Добавление квестов

```
Что реализовать:
├─ Команда /addtask {описание}
├─ Валидация входных данных
├─ Вызов ChatGPT API с промптом
├─ Обработка ошибок от AI
├─ Сохранение квеста в Firebase
└─ Ответ пользователю с сгенерированным сюжетом

Результат:
└─ /addtask "Сходить в магазин" → квест с AI-сюжетом появляется
```

#### 2.3 День 4: Система XP и профиль

```
Что реализовать:
├─ Команда /quests (список квестов)
├─ Команда /done {номер} (отметить выполненным)
├─ Система расчета XP
├─ Система уровней
├─ Команда /profile (показ профиля)
├─ Сохранение статистики в Firebase
└─ Бейджи за достижения

Результат:
└─ Полный цикл: добавить квест → выполнить → получить XP → повысить уровень
```

#### 2.4 День 5: Полировка и тестирование

```
Что реализовать:
├─ Команда /help (справка)
├─ Обработка edge cases (пустые данные, большие тексты)
├─ Красивое форматирование сообщений (эмодзи, блоки кода)
├─ Фильтрация нежелательного контента из AI
├─ Кеширование типовых сюжетов
├─ Базовая аналитика событий
└─ Документирование кода

Результат:
└─ Готовая к тестированию базовая версия
```

---

### Этап 3: Продвинутые функции (Дни 6-7)

#### 3.1 День 6: Напоминания и уведомления

```
Что реализовать:
├─ Bull очередь для асинхронных задач
├─ Ежедневные напоминания (настраивается пользователем)
├─ Еженедельный отчет
├─ Система уведомлений о достижениях
└─ Сохранение времени напоминания в профиле

Результат:
└─ Пользователи получают таргетированные уведомления
```

#### 3.2 День 7: Лидерборд и социальные функции

```
Что реализовать:
├─ Команда /leaderboard (топ 10)
├─ Система друзей (базовая)
├─ Команда /invite (реферальная ссылка)
├─ Реферальные бонусы
└─ Лишь началась версия статистики

Результат:
└─ Социальный элемент, мотивация через конкуренцию
```

---

## 🔌 Интеграция ChatGPT API

### Архитектура вызова

```
Пользователь вводит: /addtask Сходить в магазин
                              ↓
                    ┌─────────────────┐
                    │ Task Validation │
                    └────────┬────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Check Firebase Cache    │
                    │ (типовые задачи)       │
                    └────────┬────────────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Hit? Return cached      │ → Получить готовый сюжет
                    └────────┬────────────────┘   (мгновенно)
                             │
                             ↓ Miss
                    ┌─────────────────────────┐
                    │ Compose Prompt          │
                    │ - Theme selection       │
                    │ - Task description      │
                    │ - System rules          │
                    └────────┬────────────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Call OpenAI API         │
                    │ (GPT-3.5-turbo)         │
                    └────────┬────────────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Response Processing     │
                    │ - Validate output       │
                    │ - Filter bad content    │
                    │ - Extract text          │
                    └────────┬────────────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Save to Firebase        │
                    │ + Cache                 │
                    └────────┬────────────────┘
                             ↓
                    ┌─────────────────────────┐
                    │ Send to User            │
                    │ "Квест создан!"         │
                    └─────────────────────────┘
```

### Обработка ошибок ChatGPT

```
Сценарий 1: Timeout (>5 сек)
├─ Пользователю: "Генерирую... попробую еще раз"
├─ Повтор запроса через 3 сек
└─ Если еще timeout: использовать шаблонный сюжет

Сценарий 2: Нежелательный контент в ответе
├─ Фильтр вредоносного контента
├─ Повторный запрос с более строгим промптом
└─ Если опять плохо: использовать генерический шаблон

Сценарий 3: Invalid API Key
├─ Ошибка в логах (CRITICAL)
├─ Уведомление администратору
└─ Пользователю: "Техническая ошибка, попробуйте позже"

Сценарий 4: Rate limit (слишком много запросов)
├─ Queue система (Bull) — очередь запросов
├─ Максимум N запросов в минуту
└─ Пользователю: "Слишком много запросов, подождите..."

Оптимизация затрат:
├─ Кешировать типовые задачи (самые частые)
│  └─ Топ-50 задач из истории пользователей
├─ Пакетировать запросы (batch processing)
├─ Использовать более дешевые модели для коротких ответов
└─ Лимит 5 генераций на день на пользователя (после MVP)
```

### Примеры промптов

```
ПРОМПТ 1: Fantasy Theme
┌─────────────────────────────────────────────────────────┐
│ Ты создатель квестов в фэнтези мире.                   │
│ Превращение обычную задачу в эпический квест.          │
│ Используй язык рыцарей, волшебников и драконов.        │
│ Сюжет: 2-3 предложения.                                 │
│ Задача: {TASK}                                          │
│ Напиши только сюжет квеста без объяснений.              │
└─────────────────────────────────────────────────────────┘

Примеры выходов:
├─ Задача: "Сходить в магазин"
│  └─ "Припасы королевства заканчиваются. Витязь, 
│      помчись в рыночный ряд и добудь необходимое для 
│      выживания. Время спешит — в полдень закроется 
│      врата города!"
│
└─ Задача: "Позвонить маме"
   └─ "Королева требует доклада о твоем здоровье и 
       состоянии духа. Свяжись с ней магическим способом 
       (телефон) и докажи, что не забыл о матери!"

ПРОМПТ 2: Sci-Fi Theme (будущее)
┌─────────────────────────────────────────────────────────┐
│ Ты создатель квестов в мире киберпанка.                │
│ Превращение обычную задачу в интергалактический квест. │
│ Используй язык роботов, космоса и высоких технологий.  │
│ ...остальное как в примере выше                         │
└─────────────────────────────────────────────────────────┘

ПРОМПТ 3: Mix mode (микс из разных тем)
┌─────────────────────────────────────────────────────────┐
│ Ты создатель квестов в уникальном микс-мире.           │
│ Здесь встречаются рыцари и роботы, магия и техника.    │
│ ...                                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 💾 Система хранения данных

### Firebase Firestore структура

```
DATABASE SCHEMA
===============

Collection: users
│
├─ Document: {telegram_user_id}
│  │
│  ├─ Field: name (string)
│  │        "Алекс"
│  │
│  ├─ Field: username (string)
│  │        "@alexander_bot"
│  │
│  ├─ Field: level (number)
│  │        3
│  │
│  ├─ Field: xp (number)
│  │        240
│  │
│  ├─ Field: totalQuestsCompleted (number)
│  │        42
│  │
│  ├─ Field: badges (array)
│  │        ["Первый шаг", "Неутомимый", "Серийный киллер"]
│  │
│  ├─ Field: theme (string)
│  │        "fantasy"
│  │
│  ├─ Field: settings (map)
│  │        {
│  │          reminderTime: "19:00",
│  │          weeklyReportDay: "sunday",
│  │          language: "ru"
│  │        }
│  │
│  ├─ Field: createdAt (timestamp)
│  │        2025-10-22T10:30:00Z
│  │
│  ├─ Field: lastActiveAt (timestamp)
│  │        2025-10-22T15:45:00Z
│  │
│  └─ Field: streak (number)
│         7
│
├─ Document: {user_id_2}
│  └─ ...
│
└─ Document: ...


Collection: quests
│
├─ Document: {quest_unique_id}
│  │
│  ├─ Field: userId (string)
│  │        "{telegram_user_id}"
│  │
│  ├─ Field: title (string)
│  │        "Сходить в магазин"
│  │
│  ├─ Field: story (string)
│  │        "Ты — отважный искатель припасов..."
│  │
│  ├─ Field: xp (number)
│  │        15
│  │
│  ├─ Field: completed (boolean)
│  │        false
│  │
│  ├─ Field: theme (string)
│  │        "fantasy"
│  │
│  ├─ Field: createdAt (timestamp)
│  │        2025-10-22T10:30:00Z
│  │
│  └─ Field: completedAt (timestamp)
│         null (если не выполнена)
│         2025-10-22T14:00:00Z (если выполнена)
│
└─ Document: ...


Collection: statistics
│
├─ Document: {user_id}
│  │
│  ├─ Field: dailyQuests (map)
│  │        {
│  │          "2025-10-22": 5,
│  │          "2025-10-21": 3,
│  │          "2025-10-20": 0
│  │        }
│  │
│  ├─ Field: weeklyXp (number)
│  │        150
│  │
│  ├─ Field: monthlyXp (number)
│  │        450
│  │
│  ├─ Field: longestStreak (number)
│  │        12 (дней)
│  │
│  └─ Field: favoriteTheme (string)
│         "fantasy"
│
└─ Document: ...


Collection: analytics
│
├─ Document: {event_id}
│  │
│  ├─ Field: userId (string)
│  │        "{telegram_user_id}"
│  │
│  ├─ Field: event (string)
│  │        "quest_completed" | "level_up" | "badge_earned"
│  │
│  ├─ Field: timestamp (timestamp)
│  │        2025-10-22T14:00:00Z
│  │
│  └─ Field: metadata (map)
│         {
│           questId: "quest_123",
│           xpGained: 15,
│           newLevel: 3,
│           badge: "Неутомимый"
│         }
│
└─ Document: ...


Collection: questCache (оптимизация)
│
├─ Document: "task_grocery_shopping"
│  │
│  ├─ Field: taskKeywords (array)
│  │        ["магазин", "покупки", "продукты"]
│  │
│  ├─ Field: stories (map)
│  │        {
│  │          fantasy: "Ты искатель припасов...",
│  │          scifi: "Робот-торговец...",
│  │          cyberpunk: "В неоне ночного города..."
│  │        }
│  │
│  └─ Field: xpValue (number)
│         15
│
└─ Document: ...
```

### Запросы и индексы

```
Часто используемые запросы:

1. Получить все активные квесты пользователя:
   collection(db, "quests")
   .where("userId", "==", userId)
   .where("completed", "==", false)
   .orderBy("createdAt", "desc")

2. Получить топ-10 игроков:
   collection(db, "users")
   .orderBy("xp", "desc")
   .limit(10)

3. Получить статистику за день:
   collection(db, "statistics")
   .where("userId", "==", userId)
   .get()

4. Получить события пользователя за последний час:
   collection(db, "analytics")
   .where("userId", "==", userId)
   .where("timestamp", ">", oneHourAgo)

Нужные индексы:
├─ quests: (userId, completed) ← часто фильтруем по обоим
├─ quests: (userId, createdAt) ← для сортировки
├─ users: (xp) ↓ ← для лидерборда
└─ analytics: (userId, timestamp) ← для аналитики
```

---

## 📊 Метрики и аналитика

### Ключевые метрики для отслеживания

```
1. User Engagement
├─ Daily Active Users (DAU) — сколько уникальных пользователей в день
├─ Weekly Active Users (WAU)
├─ Monthly Active Users (MAU)
├─ Retention rate (день 1, 7, 30)
│  └─ % пользователей, вернувшихся через N дней
└─ Churn rate — % ушедших пользователей

2. Product Metrics
├─ Quests created per day (среднее)
├─ Quests completed per day (среднее)
├─ Completion rate (% выполненных от созданных)
├─ Average XP per user per day
├─ Average level progression speed
└─ Streak distribution (скольько юзеров на какой длительности)

3. ChatGPT API Usage
├─ Requests per day
├─ Tokens used per day
├─ Cost per day ($)
├─ Error rate (% неудачных запросов)
├─ Average response time (мс)
└─ Cache hit rate (%)

4. User Behavior
├─ Most popular tasks (топ-10)
├─ Preferred theme ("fantasy" доля от всех квестов)
├─ Time of day most active (когда создают квесты)
├─ Message length analysis (длинные vs короткие описания)
└─ Feature adoption (% юзеров использовали /profile)

Пример дашборда:
┌─────────────────────────────────────────────────┐
│         📊 ЕЖЕДНЕВНая АНАЛИТИКА                │
├─────────────────────────────────────────────────┤
│                                                 │
│ DAU: 245 (↑12% с вчера)                         │
│ Quests Created: 892 (↑8%)                       │
│ Completion Rate: 87% (↑3%)                      │
│                                                 │
│ 💰 ChatGPT Cost: $3.45 (↓15%)                   │
│ API Errors: 2 (0.2%)                            │
│                                                 │
│ 🏆 Avg. Level: 2.3                              │
│ Avg. Streak: 4.1 дней                           │
│                                                 │
└─────────────────────────────────────────────────┘
```

### Инструменты аналитики

```
Вариант 1: Google Analytics + Firebase
├─ Firebase Console встроена прямо в Firebase
├─ Показывает DAU, retention, события
└─ ✓ Бесплатно, просто, интегрировано

Вариант 2: Grafana + Prometheus
├─ Собирать метрики из приложения
├─ Визуализация в красивых графиках
└─ Более гибко для custom метрик

Вариант 3: Mixpanel или Amplitude
├─ Специализированные платформы аналитики
├─ Мощные инструменты для когортного анализа
└─ Платные, но есть бесплатный trial

Рекомендация: Firebase Analytics + Google Sheets для экспорта
```

---

## 🚀 От бота к приложению

### Фаза 1: Валидация идеи (Бот, недели 1-4)

```
Цель: Подтвердить, что людям нравится концепция

Критерии успеха:
├─ 100+ активных пользователей через 2 недели
├─ >70% retention day 1 (вернулись на следующий день)
├─ >50% retention day 7
├─ Completion rate >80%
├─ Positive sentiment в feedback (в /feedback команде)
└─ >10 пользователей, пригласивших друзей

Если критерии НЕ выполнены:
└─ Анализировать feedback, сделать корректировки
   ├─ Может быть, слишком сложный процесс?
   ├─ Может быть, сюжеты генерируются плохо?
   ├─ Может быть, нет хорошей мотивации?
   └─ Повторить попытку или перейти на другую идею

Если критерии выполнены:
└─ Переходить на фазу 2
```

### Фаза 2: Масштабирование бота (недели 5-8)

```
Что добавить:
├─ Расширенный функционал (социальные функции, челленджи)
├─ Более разнообразные темы
├─ Интеграции (Google Calendar импорт)
├─ A/B тестирование разных промптов
└─ Первые платные функции (premium)

Целевая метрика: 1000+ DAU
```

### Фаза 3: Разработка Native приложения (недели 9-16)

```
TIMELINE МИГРАЦИИ
=================

Неделя 9-10: Подготовка
├─ Собрать требования от feedback бота
├─ Дизайн интерфейса приложения
├─ Архитектура бэкенда API
└─ Подготовка команды разработчиков

Неделя 11-16: Разработка MVP приложения
├─ Backend API (Node.js + Express)
├─ Frontend (React Native или Flutter)
├─ Миграция данных из бота
└─ Бета-тестирование

Одновременно (неделя 9-16):
├─ БОТ продолжает работать (не отключаем!)
├─ Перенос данных пользователей из Telegram → приложение
├─ Создание механизма синхронизации (если нужно dual-app)
└─ Документирование API для новых платформ

Выход приложения: Неделя 17
├─ iOS App Store
├─ Google Play Store
├─ Параллельно бот продолжает работать
└─ Плавная миграция: "Установите приложение, все данные сохранены!"
```

### Ключевые данные для миграции

```
Что переносить из бота в приложение:
├─ User profiles (все данные)
├─ Quest history (все выполненные и текущие квесты)
├─ XP и уровни
├─ Badges и достижения
├─ Statistics (streak, история)
├─ Friends list (если реализовали)
└─ Preferences/settings

Механизм миграции:
├─ User授权 через OAuth (Google/Telegram)
├─ При первом входе в приложение, связать с Telegram ID
├─ Автоматически загрузить все данные
├─ Offer: "Продолжить игру с того же места!"
└─ Очистить старые данные в боте (опционально)

Или: Dual-app strategy (параллельное использование)
├─ Пользователь может использовать и бот, И приложение
├─ Синхронизация данных в реальном времени через API
├─ +Доп. функции в приложении (графика, UI)
└─ -Усложняет разработку
```

---

## 🛠️ Дополнительные инструменты и сервисы

### Хостинг для бота

```
Вариант 1: Heroku (Рекомендую для MVP)
├─ Бесплатный уровень: 550 dyno часов в месяц
├─ Webhook для Telegram API
├─ Просто деплоим Git
└─ Цена: $7/месяц (обновили)

Вариант 2: Railway.app
├─ Более современная альтернатива Heroku
├─ Бесплатные кредиты $5/месяц
├─ Простой деплой
└─ Цена: pay-as-you-go

Вариант 3: AWS Lambda + API Gateway
├─ Дешево, если низкая нагрузка
├─ Масштабируется автоматически
└─ Цена: $0.20 за миллион запросов

Рекомендация: Heroku (простой старт) → Railway.app (долгосроч)
```

### Мониторинг и логирование

```
Logginт:
├─ Winston (библиотека для Node.js)
├─ Все события (quests, errors, API calls)
├─ Отправлять в облако (Loggly, ELK Stack)
└─ Ротация логов по дням

Мониторинг:
├─ Uptime monitoring (UptimeRobot)
├─ Performance monitoring (New Relic)
├─ Error tracking (Sentry)
└─ Alerts при проблемах

Рекомендация: Winston (бесплатно) + Sentry (free tier)
```

---

## ✅ Чек-лист развертывания

### До запуска бота

```
☐ Создан проект в Firebase
☐ Создан Telegram бот (@BotFather)
☐ Получены API ключи (OpenAI, Telegram, Firebase)
☐ Переменные окружения настроены (.env)
☐ Код написан и протестирован локально
☐ Создано хранилище данных (Firestore)
☐ Webhooks настроены (или Polling готов)
☐ Логирование работает
☐ Мониторинг настроен
☐ Документация написана
```

### День запуска

```
☐ Финальное тестирование (5 человек внутри)
☐ Проверка всех команд
☐ Проверка ChatGPT генерации (разные типы задач)
☐ Проверка Firebase записи/чтения
☐ Проверка уведомлений
☐ Развертывание на хостинге (Heroku)
☐ Создание ссылки для приглашения юзеров
☐ Подготовка первого сообщения с инструкциями
☐ Включение мониторинга
☐ Готовность к инцидентам
```

### После запуска

```
☐ День 1: Активный мониторинг, оперативное исправление ошибок
☐ День 2-3: Сбор feedback от первых пользователей
☐ День 4-7: Анализ метрик, обновление функционала
☐ Неделя 2+: Планирование фаз развития
```

---

## 📝 Итоговая таблица

| Аспект | Описание | Сроки |
|--------|---------|--------|
| **Язык** | Node.js + Express.js | - |
| **Telegram Lib** | Telegraf | - |
| **БД** | Firebase Firestore | - |
| **AI** | OpenAI ChatGPT-3.5 | - |
| **Хостинг** | Heroku / Railway | - |
| **MVP функционал** | /start, /addtask, /quests, /done, /profile | 5 дней |
| **Продвинутый функционал** | /stats, /leaderboard, напоминания | 2 дня |
| **Тестирование** | Закрытое тестирование с 20-50 бета-тестерами | 1 неделя |
| **Открытый запуск** | Приглашение друзей, реф-программа | Неделя 2 |
| **Масштабирование** | Расширение функционала, новые темы | Недели 3-4 |
| **Миграция на приложение** | Разработка Native/Flutter приложения | Недели 5-8 |

---

## 🎯 Что дальше?

**Когда вы дадите разрешение:**

1. Я напишу подробный код для:
   - `bot.js` — главный файл
   - `handlers/` — обработчики команд
   - `services/` — бизнес-логика
   - `integrations/chatgpt.js` — интеграция ChatGPT

2. Предоставлю готовые prompt'ы для разных тем

3. Создам инструкцию по развертыванию на Heroku

4. Подготовлю шаблон .env и package.json

---

**Готовы к разработке? 🚀**
