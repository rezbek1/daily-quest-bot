/**
 * üí¨ QUOTES - src/utils/quotes.js
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–∏—Ç–∞—Ç –¥–Ω—è —á–µ—Ä–µ–∑ ChatGPT
 */

const axios = require('axios');
const logger = require('../logger');
const config = require('../config');
const { PROMPTS } = require('../modules/quests/prompts');

// Fallback —Ü–∏—Ç–∞—Ç—ã –µ—Å–ª–∏ ChatGPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
const FALLBACK_QUOTES = [
  "–£—Å–ø–µ—à–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å - —ç—Ç–æ —Ç–æ—Ç, –∫—Ç–æ –Ω–∞—É—á–∏–ª—Å—è —Å–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–∏–∫—É",
  "–õ—É—á—à–µ –±—ã—Ç—å –Ω–µ—É–¥–∞—á–Ω–∏–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø—ã—Ç–∞–µ—Ç—Å—è, —á–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–∞–ª—Å—è",
  "–ú–æ—Ç–∏–≤–∞—Ü–∏—è - —ç—Ç–æ —Ç–æ, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–±—è –Ω–∞—á–∞—Ç—å. –ü—Ä–∏–≤—ã—á–∫–∞ - —ç—Ç–æ —Ç–æ, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–±—è –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å",
  "–¢—ã –Ω–µ –º–æ–∂–µ—à—å –ø–æ–±–µ–¥–∏—Ç—å –≤—á–µ—Ä–∞, –Ω–æ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å –ª—É—á—à–µ–≥–æ —Å–µ–≥–æ–¥–Ω—è",
  "–ö–∞–∂–¥–∞—è –Ω–µ—É–¥–∞—á–∞ - —ç—Ç–æ —à–∞–Ω—Å —Å—Ç–∞—Ç—å –ª—É—á—à–µ",
  "–ù–µ –∂–¥–∏ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞. –í–æ–∑—å–º–∏ –º–æ–º–µ–Ω—Ç –∏ —Å–¥–µ–ª–∞–π –µ–≥–æ –∏–¥–µ–∞–ª—å–Ω—ã–º",
  "–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö. –û–Ω –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç —Ç–µ–±—è",
  "–ë–æ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–∞. –û—Ç–∫–∞–∑ –æ—Ç –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞–≤—Å–µ–≥–¥–∞",
  "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å - —ç—Ç–æ –±–æ–ª—å—à–µ, —á–µ–º –±–æ–ª—å—à–∏–µ —à–∞–≥–∏ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü",
  "–ï—Å–ª–∏ —Ç—ã –Ω–µ —Å–ø–µ—à–∏—à—å, —Ç–æ –∫—É–¥–∞ —Ç—ã –∏–¥–µ—à—å?",
  "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å",
  "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, —á–µ–≥–æ –±–æ–∏—à—å—Å—è –¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞",
  "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã - —ç—Ç–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ —É—Å–∏–ª–∏—è",
  "–ù–µ –∂–¥–∏. –í—Ä–µ–º—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç '–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–∏–º'",
  "–ö–∞–∂–¥—ã–π –º–∞—Å—Ç–µ—Ä –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª –Ω–æ–≤–∏—á–∫–æ–º",
  "–£—Å–ø–µ—Ö - —ç—Ç–æ –Ω–µ —Ñ–∏–Ω–∞–ª, –Ω–µ—É–¥–∞—á–∞ - —ç—Ç–æ –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞. –í–∞–∂–Ω–∞ —Å–º–µ–ª–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
  "–¢–≤–æ—è —Ä–∞–±–æ—Ç–∞ - —ç—Ç–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —á–∞—Å—ã —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∞ —Å—Ç–æ–∏—Ç —Ç–æ–≥–æ",
  "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ - —ç—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ, –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ",
  "–û—Å—Ç–∞—Ç—å—Å—è –≤–µ—Ä–Ω—ã–º —Å–µ–±–µ - —ç—Ç–æ —Ä–µ–≤–æ–ª—é—Ü–∏—è",
  "–ù–∞—á–Ω–∏ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤",
];

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ü–∏—Ç–∞—Ç—É –¥–Ω—è –æ—Ç ChatGPT
 */
async function getQuoteOfDayFromGPT() {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º prompt –¥–ª—è —Ü–∏—Ç–∞—Ç
    const prompt = PROMPTS.quote;
    
    const response = await axios.post(
      'https://api.openai.com/v1/chat/completions',
      {
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: '–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –æ—Å—Ç—Ä–æ—É–º–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π.' },
          { role: 'user', content: prompt },
        ],
        max_tokens: 100,
        temperature: 0.9,
      },
      {
        headers: {
          Authorization: `Bearer ${config.OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
        },
        timeout: 5000,
      }
    );

    const quote = response.data.choices[0].message.content.trim();
    
    if (quote) {
      logger.info(`üí¨ –ù–æ–≤–∞—è —Ü–∏—Ç–∞—Ç–∞ –æ—Ç ChatGPT: ${quote}`);
      return quote;
    }
  } catch (error) {
    logger.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç—ã –æ—Ç ChatGPT:', error.message);
  }
  
  // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –≤–µ—Ä–Ω—É—Ç—å fallback —Ü–∏—Ç–∞—Ç—É
  return getQuoteOfDayFallback();
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ü–∏—Ç–∞—Ç—É –¥–Ω—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã (–µ—Å–ª–∏ ChatGPT –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
 */
function getQuoteOfDayFallback() {
  // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä –¥–Ω—è –≤ –≥–æ–¥—É (0-365)
  const today = new Date();
  const start = new Date(today.getFullYear(), 0, 0);
  const diff = today - start;
  const oneDay = 1000 * 60 * 60 * 24;
  const dayOfYear = Math.floor(diff / oneDay);
  
  // –í—ã–±—Ä–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –ø–æ –¥–Ω—é (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏)
  const quoteIndex = dayOfYear % FALLBACK_QUOTES.length;
  return FALLBACK_QUOTES[quoteIndex];
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ü–∏—Ç–∞—Ç—É –¥–Ω—è (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –¥–µ–Ω—å)
 */
let cachedQuote = null;
let cachedDate = null;

async function getQuoteOfDay() {
  // –ï—Å–ª–∏ —É–∂–µ –∫—ç—à–∏—Ä–æ–≤–∞–ª–∏ —Ü–∏—Ç–∞—Ç—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - –≤–µ—Ä–Ω—É—Ç—å –µ—ë
  const today = new Date().toDateString();
  if (cachedQuote && cachedDate === today) {
    return cachedQuote;
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é —Ü–∏—Ç–∞—Ç—É –æ—Ç ChatGPT –∏–ª–∏ fallback
  const quote = await getQuoteOfDayFromGPT();
  
  // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–µ–Ω—å
  cachedQuote = quote;
  cachedDate = today;
  
  return quote;
}

module.exports = {
  getQuoteOfDay,
  getQuoteOfDayFromGPT,
  getQuoteOfDayFallback,
  FALLBACK_QUOTES,
};
