/**
 * üì¶ QUESTS CREATOR - quests/creator.js
 * –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–π
 */

const axios = require('axios');
const logger = require('../../logger');
const config = require('../../config');
const { db } = require('../../db');
const prompts = require('./prompts');

/**
 * –°–æ–∑–¥–∞—Ç—å –∫–≤–µ—Å—Ç
 */
async function createQuest(userId, taskDescription) {
  try {
    const user = await db.getUser(userId);
    if (!user) {
      logger.warn(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞`);
      return null;
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const theme = user.theme || 'black';

    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–≤–µ—Å—Ç–∞
    logger.info(`üìù –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –∫–≤–µ—Å—Ç–∞ –¥–ª—è ${userId}...`);
    const story = await generateQuestStory(taskDescription, theme);

    // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å XP –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –æ–ø–∏—Å–∞–Ω–∏—è
    const xp = Math.min(10 + Math.floor(taskDescription.length / 10), 50);

    // –°–æ–∑–¥–∞—Ç—å –∫–≤–µ—Å—Ç –≤ –ë–î
    const questData = {
      userId: userId.toString(),
      questNumber: user.totalQuestsCompleted + 1,
      title: taskDescription,
      story: story,
      xp: xp,
      theme: theme,
      completed: false,
      createdAt: new Date(),
      completedAt: null,
    };

    const questRef = db.db.collection('quests').doc();
    await questRef.set(questData);

    logger.info(`‚úÖ –ö–≤–µ—Å—Ç #${questData.questNumber} —Å–æ–∑–¥–∞–Ω: "${taskDescription}"`);

    return {
      id: questRef.id,
      questNumber: questData.questNumber,
      title: questData.title,
      story: questData.story,
      xp: questData.xp,
    };
  } catch (error) {
    logger.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–µ—Å—Ç–∞:', error);
    return null;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–≤–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ ChatGPT
 */
async function generateQuestStory(taskDescription, theme = 'black') {
  try {
    const promptTemplate = prompts.PROMPTS[theme] || prompts.PROMPTS.black;
    const prompt = promptTemplate.replace('{TASK}', taskDescription);

    const response = await axios.post(
      'https://api.openai.com/v1/chat/completions',
      {
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: '–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–≤–µ—Å—Ç–æ–≤ —Å —á–µ—Ä–Ω—ã–º —é–º–æ—Ä–æ–º.' },
          { role: 'user', content: prompt },
        ],
        max_tokens: 300,
        temperature: 0.8,
      },
      {
        headers: {
          Authorization: `Bearer ${config.OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
        },
        timeout: 10000,
      }
    );

    return response.data.choices[0].message.content.trim();
  } catch (error) {
    logger.error('‚ùå –û—à–∏–±–∫–∞ ChatGPT:', error.message);
    return '–û–±–ª–∞–≥–æ—Ä–æ–¥—å —ç—Ç—É –∑–∞–¥–∞—á—É —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ —á–µ—Å—Ç–Ω—ã–º.';
  }
}

module.exports = {
  createQuest,
  generateQuestStory,
};

---

/**
 * üì¶ QUESTS PROMPTS - quests/prompts.js
 * –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è ChatGPT
 */

const PROMPTS = {
  light: `–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∑–∞–±–∞–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –Ω–µ –ø–æ—Ç–µ—Ä—è–ª–∏ –Ω–∞–¥–µ–∂–¥—É.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á—É –≤ –≤–µ—Å—ë–ª—ã–π –∫–≤–µ—Å—Ç —Å –ª—ë–≥–∫–∏–º —Å–∞—Ä–∫–∞–∑–º–æ–º.
–Æ–º–æ—Ä –º—è–≥–∫–∏–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π, –Ω–æ –≤—Å—ë –µ—â—ë —Ü–∏–Ω–∏—á–Ω—ã–π.
–ü–†–ê–í–ò–õ–ê: –ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (150 —Å–ª–æ–≤), –ª—ë–≥–∫–∏–π —é–º–æ—Ä, —à—É—Ç–∫–∏.
–ó–ê–î–ê–ß–ê: {TASK}
–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –∫–≤–µ—Å—Ç–∞, –ë–ï–ó –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`,

  black: `–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–≤–µ—Å—Ç–æ–≤ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–Ω–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á—É –≤ –∫–≤–µ—Å—Ç —Å –ß–Å–†–ù–´–ú –Æ–ú–û–†–û–ú.
–ë–µ–∑ —Å–∞—Ö–∞—Ä–∞, –±–µ–∑ –ø–æ–∑–∏—Ç–∏–≤–∞. –¶–∏–Ω–∏—á–Ω—ã–π, –æ—Å—Ç—Ä—ã–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π.
–ü–†–ê–í–ò–õ–ê: –ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (150 —Å–ª–æ–≤), —á—ë—Ä–Ω—ã–π —é–º–æ—Ä, —Å–∞—Ä–∫–∞–∑–º, —Ü–∏–Ω–∏–∑–º –ü–†–ò–í–ï–¢–°–¢–í–£–ï–¢–°–Ø.
–ó–ê–î–ê–ß–ê: {TASK}
–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –∫–≤–µ—Å—Ç–∞, –ë–ï–ó –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`,

  venture: `–¢—ã –∏–Ω–≤–µ—Å—Ç–æ—Ä –ø–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ –ø–∏—Ç—á–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç —Å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–º –æ –µ–≥–æ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–µ.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –û–ø–∏—Å–∞—Ç—å –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á—É –∫–∞–∫ —Å—É—Ä–æ–≤—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ–Ω—á—É—Ä–Ω–æ–≥–æ –¥–Ω–∞.
–ú–ê–ö–°–ò–ú–£–ú –±–æ–ª–∏, —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –±–µ—Å–ø–æ—â–∞–¥–Ω–æ—Å—Ç–∏.
–ü–†–ê–í–ò–õ–ê: –ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (150 —Å–ª–æ–≤), –ú–ê–ö–°–ò–ú–£–ú —Å–∞—Ä–∫–∞–∑–º–∞ –∏ –∂—ë—Å—Ç–∫–æ—Å—Ç–∏.
–ó–ê–î–ê–ß–ê: {TASK}
–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –∫–≤–µ—Å—Ç–∞, –ë–ï–ó –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`,

  quote: `–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –æ—Å—Ç—Ä–æ—É–º–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–Ω–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å –û–î–ù–£ –∫–æ—Ä–æ—Ç–∫—É—é, —è–∑–≤–∏—Ç–µ–ª—å–Ω—É—é —Ü–∏—Ç–∞—Ç—É –ø—Ä–æ –∂–∏–∑–Ω—å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è.
–ú–∞–∫—Å–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏. –Ø–∑—ã–∫: —á—ë—Ä–Ω—ã–π —é–º–æ—Ä, —Ü–∏–Ω–∏—á–Ω—ã–π, –±–µ—Å–ø–æ—â–∞–¥–Ω–æ —á–µ—Å—Ç–Ω—ã–π.
–ü–†–ê–í–ò–õ–ê: –û–î–ù–ê —Ü–∏—Ç–∞—Ç–∞, –º–∞–∫—Å–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏, –º–∞–∫—Å–∏–º—É–º —Å–∞—Ä–∫–∞–∑–º–∞ –∏ —á—ë—Ä–Ω–æ–≥–æ —é–º–æ—Ä–∞.
–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û —Ü–∏—Ç–∞—Ç—É, –ë–ï–ó –∫–∞–≤—ã—á–µ–∫, –ë–ï–ó –∞–≤—Ç–æ—Ä–∞.`,
};

module.exports = { PROMPTS };
